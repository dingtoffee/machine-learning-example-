# Network Scan Use Case

The first use case I will illustrate here is to detect network scanning activities using Machine Learning. The model developed will be tested to evaluate whether after we have included some environmental feature i.e. specific features related to your environment. We will be able to generate a model that could significantly reduce the False Positive rate when compared to static detection rule e.g. IPS.

## What are network scanning activities?

Network scanning is one of the most common types of activities performed by hackers. It is the first step in the cyber kill-chain — RECONNAISSANCE where hackers aim to collect information about the targets.
The typical network scanning activities could be conducted by tools like Nmap. These will generate packets that trying to probe a specific IP range with different destination port specified.

## Feature Generation

To detect network scanning, I will need to find relevant logs that would capture these kinds of network activities. After a while, I decided the firewall log will be a good source of data.
It describes the source IP address, destination IP address, service/destination port and the action performed by firewall e.g. blocked, allowed.

## DataSet

To make the machine learning algorithm understand our dataset, we will need to go through the process of data transformation — Feature Generation. From my experience, I have spent most of the time doing the right generation as it often requires the analyst to have a thorough understanding of the use cases i.e. what you want to detect, the data i.e. how the attack will look like in the log perspective and also the attack process i.e. what are the known “bad traffic”. If the feature generation is not done properly, it will affect the subsequent steps and finally affect the performance of the model. It might happen from time to time that you will go back to this step to question whether you have missed some features.
For this use case, it is relatively simple, I have put down the assumption that network scanning will generate a lot of packet traffic in a short period and we have also assumed that the deny traffic will have a higher proportion than the accept traffic. Therefore，a list of features have been generated from an enterprise firewall:
- TOTAL — Total packet generated within 15 minutes-time.
- ACCEPT _COUNT — Total number of accept actions performed by a firewall within 15 minutes-time.
- DENY_COUNT — TOTAL number of “deny” action performed by the firewall within 15 minutes-time.
- Internet — Whether the Source_IP is an public IP address (i. 0 = No; 1 = Yes)
- isinfra — This is a specific parameter that I generated by providing a list of common infrastructure I know in the environment. If the source IP is coming from this list of infrastructure it will be tagged as 0 and vise versa, 1.
- protco_count — the number of destination port the source IP initiated to
- ip_c — the number of destination IP address that the source IP address initiated.
- date_occurance — how many times within the past 7 days I have seen this IP address on the firewall log.

I have prepared the data set that is extracted from a lab firewall which I built with basic infrastructure such as AD, Zabbix servers, other network devices.
As part of the supervised learning, I have also provided an additional data column “tag” — if this is a known IPSWEEP attack, it will be flagged as 1; PORT SCAN, it will be flagged as 2, while normal traffic will be 0.
For both of the PORT SCAN and IPSWEEP scan, it is generated by Nmap.

## Model Selection

I have done some evaluation on the data and noted that the decision-tree classifier, one of the supervised learning model, seems to be a good fit.
Decision Tree Classifier
A Decision Tree is a simple representation of classifying examples. It is a Supervised Machine Learning where the data is continuously split according to a certain parameter.
Decision Tree consists of :
- Nodes: Test for the value of a certain attribute.
- Edges/Branch: Correspond to the outcome of a test and connect to the next node or leaf.
- Leaf Nodes: Terminal nodes that predict the outcome (represent class labels or class distribution).

## Result

The model could achieve 98% F1-score.

## Remarks

I have also put this model developed into MLTK and run it in a production environment where I compared the results with a commerical off-the-shelf detection tool on the IPSWEEP and PORT SCAN detection. While they both could detect the port scan activities, my model actually generate less false positive results as it has taken into account whether this is a known pattern or known infrastructure that will generate similar pattern as a port scan.
Next-Step: Decision tree is known to be unstable because small variations in the data might result in a completely different tree generated. Also, the sample data I used may apply to the specific environment only. It is best if you re-run the training/testing procedure to generate the set of data that matches your environment the most. Possible evaluation to see if we could use another model such as boosting and bagging to lower the variance.
